<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Type Inference Story</title>
  <style>
    :root {
      --bg: #1a1a2e;
      --bg-accent: #16213e;
      --panel: #0f0f23;
      --ink: #e8e8e8;
      --muted: #888;
      --accent: #00d9ff;
      --accent-2: #ff6b6b;
      --accent-3: #50fa7b;
      --hover: rgba(0, 217, 255, 0.15);
      --line: rgba(255, 255, 255, 0.1);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: var(--bg);
      color: var(--ink);
      font-family: "JetBrains Mono", "Fira Code", monospace;
      font-size: 13px;
      line-height: 1.6;
    }
    main {
      max-width: 1800px;
      margin: 0 auto;
      padding: 20px;
    }
    .page-header {
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--line);
    }
    .eyebrow {
      text-transform: uppercase;
      letter-spacing: 0.2em;
      font-size: 11px;
      color: var(--accent);
      margin-bottom: 4px;
    }
    h1 { font-size: 24px; font-weight: 600; }
    h2 { font-size: 16px; font-weight: 600; margin-bottom: 12px; }
    h3 { font-size: 14px; font-weight: 600; color: var(--muted); margin-bottom: 8px; }
    .subtitle { color: var(--muted); font-size: 13px; }
    .panels {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      height: calc(100vh - 140px);
    }
    section {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 8px;
      padding: 16px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .section-header {
      margin-bottom: 12px;
      flex-shrink: 0;
    }
    .file-tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 12px;
      flex-shrink: 0;
    }
    .file-tab {
      background: transparent;
      border: 1px solid var(--line);
      color: var(--muted);
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      font-family: inherit;
    }
    .file-tab.active {
      background: var(--accent);
      color: var(--bg);
      border-color: var(--accent);
    }
    .file-content { overflow: auto; flex: 1; }
    .source {
      background: var(--bg-accent);
      padding: 12px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 13px;
      line-height: 1.6;
    }
    .source code { display: block; white-space: pre; }
    .node {
      cursor: pointer;
      border-radius: 2px;
      transition: background 0.1s;
    }
    .node:hover {
      background: var(--hover);
    }
    .node.has-events {
      border-bottom: 1px dashed var(--accent);
    }
    .node.selected {
      background: rgba(0, 217, 255, 0.3);
      outline: 1px solid var(--accent);
    }
    .story-panel {
      overflow: hidden;
    }
    .story-content {
      flex: 1;
      overflow: auto;
      padding-right: 8px;
    }
    .hint {
      color: var(--muted);
      font-style: italic;
    }
    .story-header {
      background: var(--bg-accent);
      padding: 12px;
      border-radius: 4px;
      margin-bottom: 12px;
    }
    .story-header h3 {
      color: var(--accent);
      margin-bottom: 4px;
    }
    .story-header .metas {
      color: var(--accent-2);
      font-size: 12px;
    }
    .event-list {
      list-style: none;
    }
    .event-item {
      padding: 8px 12px;
      border-left: 2px solid var(--line);
      margin-left: 8px;
      margin-bottom: 4px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.1s;
    }
    .event-item:hover {
      background: var(--hover);
      border-left-color: var(--accent);
    }
    .event-item.meta-created {
      border-left-color: var(--accent-3);
    }
    .event-item.constraint-created {
      border-left-color: var(--accent);
    }
    .event-item.constraint-deferred {
      border-left-color: var(--accent-2);
    }
    .event-item.constraint-woken {
      border-left-color: #bd93f9;
    }
    .event-item.constraint-solved {
      border-left-color: var(--accent-3);
    }
    .event-item.meta-unified {
      border-left-color: #f1fa8c;
    }
    .event-item.meta-linked {
      border-left-color: #ffb86c;
    }
    .event-type {
      font-weight: 600;
      margin-right: 8px;
    }
    .event-detail {
      color: var(--muted);
    }
    .meta-tag {
      display: inline-block;
      background: var(--bg);
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 11px;
      margin: 2px;
      cursor: pointer;
    }
    .meta-tag:hover {
      background: var(--accent);
      color: var(--bg);
    }
    .filter-bar {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    .filter-btn {
      background: transparent;
      border: 1px solid var(--line);
      color: var(--muted);
      padding: 4px 8px;
      border-radius: 3px;
      cursor: pointer;
      font-size: 11px;
      font-family: inherit;
    }
    .filter-btn.active {
      background: var(--accent);
      color: var(--bg);
      border-color: var(--accent);
    }
  </style>
</head>
<body>
<main>
<header class="page-header">
  <div>
    <p class="eyebrow">Type Checker</p>
    <h1>Type Inference Story</h1>
    <p class="subtitle">53 events captured</p>
  </div>
</header>
<div class="panels">
<section class="source-panel">
  <div class="section-header">
    <h2>Source</h2>
  </div>
  <div class="file-tabs">
    <button class="file-tab active" data-file="0">b.tlk</button>
    <button class="file-tab" data-file="1">a.tlk</button>
  </div>
  <div class="file-content" data-file="0" style="display: block">
    <h3>b.tlk</h3>
    <pre class="source"><code><span class="node has-events" data-node="0:4" data-events="1" data-metas="?2">struct B {
  <span class="node" data-node="0:2" data-events="0" data-metas="">let a: A</span>
}</span>

<span class="node" data-node="0:5" data-events="0" data-metas="">B</span>(a<span class="node has-events" data-node="0:13" data-events="1" data-metas="?7, ?8"><span class="node has-events" data-node="0:12" data-events="1" data-metas="?6, ?7"><span class="node has-events" data-node="0:11" data-events="2" data-metas="?6, ?5">: <span class="node" data-node="0:10" data-events="0" data-metas=""><span class="node" data-node="0:6" data-events="0" data-metas="">A</span>(<span class="node has-events" data-node="0:9" data-events="2" data-metas="?4, ?5">count<span class="node" data-node="0:8" data-events="0" data-metas="">: <span class="node has-events" data-node="0:7" data-events="1" data-metas="?4">1</span></span>)</span></span>)</span>.a</span>.count</span></code></pre>
  </div>
  <div class="file-content" data-file="1" style="display: none">
    <h3>a.tlk</h3>
    <pre class="source"><code><span class="node has-events" data-node="1:4" data-events="1" data-metas="?0">struct A {
  <span class="node" data-node="1:2" data-events="0" data-metas="">let count: Int</span>
}</span></code></pre>
  </div>
</section>
<section class="story-panel">
  <div class="section-header">
    <h2>Story</h2>
  </div>
  <div class="story-content" id="story-content">
    <p class="hint">Click on code to see its type inference story</p>
  </div>
</section>
</div>
</main>
<script>
const EVENTS = [
  {"type":"MetaCreated","id":1,"meta":"?0","level":0,"node":null},
  {"type":"MetaCreated","id":5,"meta":"?row0","level":1,"node":null},
  {"type":"MetaCreated","id":7,"meta":"?1","level":2,"node":null},
  {"type":"ConstraintCreated","id":8,"constraintId":"ConstraintId(1)","kind":"Member","node":"4294967294:12","metas":["?1"]},
  {"type":"ConstraintCreated","id":13,"constraintId":"ConstraintId(2)","kind":"Equals","node":"4294967294:11","metas":["?1"]},
  {"type":"ConstraintCreated","id":15,"constraintId":"ConstraintId(3)","kind":"Equals","node":"1:4","metas":["?0"]},
  {"type":"MetaUnified","id":16,"meta":"?1","unifiedWith":"Int","viaConstraint":null},
  {"type":"ConstraintSolved","id":17,"constraintId":"ConstraintId(2)","resolvedMetas":["?1"]},
  {"type":"MetaUnified","id":18,"meta":"?0","unifiedWith":"Nominal(@Struct(StructId { module_id: _, local_id: 2 }), A, [])","viaConstraint":null},
  {"type":"ConstraintSolved","id":19,"constraintId":"ConstraintId(3)","resolvedMetas":["?0"]},
  {"type":"ConstraintSolved","id":20,"constraintId":"ConstraintId(1)","resolvedMetas":[]},
  {"type":"MetaCreated","id":26,"meta":"?2","level":0,"node":null},
  {"type":"MetaCreated","id":35,"meta":"?row1","level":1,"node":null},
  {"type":"MetaCreated","id":37,"meta":"?3","level":2,"node":null},
  {"type":"ConstraintCreated","id":39,"constraintId":"ConstraintId(4)","kind":"Member","node":"4294967294:21","metas":["?3"]},
  {"type":"ConstraintCreated","id":41,"constraintId":"ConstraintId(5)","kind":"Equals","node":"4294967294:20","metas":["?3"]},
  {"type":"ConstraintCreated","id":48,"constraintId":"ConstraintId(6)","kind":"Equals","node":"0:4","metas":["?2"]},
  {"type":"MetaUnified","id":53,"meta":"?3","unifiedWith":"Nominal(@Struct(StructId { module_id: _, local_id: 2 }), A, [])","viaConstraint":null},
  {"type":"ConstraintSolved","id":54,"constraintId":"ConstraintId(5)","resolvedMetas":["?3"]},
  {"type":"MetaUnified","id":55,"meta":"?2","unifiedWith":"Nominal(@Struct(StructId { module_id: _, local_id: 1 }), B, [])","viaConstraint":null},
  {"type":"ConstraintSolved","id":56,"constraintId":"ConstraintId(6)","resolvedMetas":["?2"]},
  {"type":"ConstraintSolved","id":60,"constraintId":"ConstraintId(4)","resolvedMetas":[]},
  {"type":"MetaCreated","id":63,"meta":"?4","level":2,"node":null},
  {"type":"ConstraintCreated","id":64,"constraintId":"ConstraintId(7)","kind":"DefaultTy","node":"0:7","metas":["?4"]},
  {"type":"MetaCreated","id":65,"meta":"?5","level":2,"node":null},
  {"type":"MetaCreated","id":66,"meta":"?row2","level":2,"node":null},
  {"type":"ConstraintCreated","id":67,"constraintId":"ConstraintId(8)","kind":"Call","node":"0:9","metas":["?4","?5"]},
  {"type":"MetaCreated","id":68,"meta":"?6","level":1,"node":null},
  {"type":"MetaCreated","id":69,"meta":"?row3","level":1,"node":null},
  {"type":"ConstraintCreated","id":70,"constraintId":"ConstraintId(9)","kind":"Call","node":"0:11","metas":["?5","?6"]},
  {"type":"MetaCreated","id":71,"meta":"?7","level":1,"node":null},
  {"type":"ConstraintCreated","id":72,"constraintId":"ConstraintId(10)","kind":"Member","node":"0:12","metas":["?6","?7"]},
  {"type":"MetaCreated","id":73,"meta":"?8","level":1,"node":null},
  {"type":"ConstraintCreated","id":74,"constraintId":"ConstraintId(11)","kind":"Member","node":"0:13","metas":["?7","?8"]},
  {"type":"ConstraintDeferred","id":75,"constraintId":"ConstraintId(10)","reason":"WaitingOnMeta(Ty(meta(6)))"},
  {"type":"ConstraintDeferred","id":76,"constraintId":"ConstraintId(11)","reason":"WaitingOnMeta(Ty(meta(7)))"},
  {"type":"ConstraintCreated","id":77,"constraintId":"ConstraintId(12)","kind":"Equals","node":"0:9","metas":["?5"]},
  {"type":"MetaUnified","id":78,"meta":"?4","unifiedWith":"Int","viaConstraint":null},
  {"type":"ConstraintSolved","id":79,"constraintId":"ConstraintId(8)","resolvedMetas":["?4"]},
  {"type":"ConstraintCreated","id":80,"constraintId":"ConstraintId(13)","kind":"Equals","node":"0:11","metas":["?6"]},
  {"type":"MetaUnified","id":81,"meta":"?5","unifiedWith":"Nominal(@Struct(StructId { module_id: _, local_id: 2 }), A, [])","viaConstraint":null},
  {"type":"ConstraintSolved","id":82,"constraintId":"ConstraintId(9)","resolvedMetas":["?5"]},
  {"type":"ConstraintSolved","id":83,"constraintId":"ConstraintId(7)","resolvedMetas":[]},
  {"type":"ConstraintWoken","id":84,"constraintId":"ConstraintId(12)","wokenBy":"metas [Ty(meta(4)), Ty(meta(5))]"},
  {"type":"ConstraintSolved","id":85,"constraintId":"ConstraintId(12)","resolvedMetas":[]},
  {"type":"MetaUnified","id":86,"meta":"?6","unifiedWith":"Nominal(@Struct(StructId { module_id: _, local_id: 1 }), B, [])","viaConstraint":null},
  {"type":"ConstraintSolved","id":87,"constraintId":"ConstraintId(13)","resolvedMetas":["?6"]},
  {"type":"ConstraintWoken","id":88,"constraintId":"ConstraintId(10)","wokenBy":"metas [Ty(meta(6))]"},
  {"type":"MetaUnified","id":89,"meta":"?7","unifiedWith":"Nominal(@Struct(StructId { module_id: _, local_id: 2 }), A, [])","viaConstraint":null},
  {"type":"ConstraintSolved","id":90,"constraintId":"ConstraintId(10)","resolvedMetas":["?7"]},
  {"type":"ConstraintWoken","id":91,"constraintId":"ConstraintId(11)","wokenBy":"metas [Ty(meta(7))]"},
  {"type":"MetaUnified","id":92,"meta":"?8","unifiedWith":"Int","viaConstraint":null},
  {"type":"ConstraintSolved","id":93,"constraintId":"ConstraintId(11)","resolvedMetas":["?8"]}
];
</script>

<script>
const storyContent = document.getElementById('story-content');
let selectedNode = null;
let selectedMeta = null;

// Build index: node -> events
const eventsByNode = {};
const metasByNode = {};
EVENTS.forEach((event, idx) => {
  if (event.node) {
    if (!eventsByNode[event.node]) eventsByNode[event.node] = [];
    eventsByNode[event.node].push(idx);
  }
  // Track metas by node
  if (event.node && event.metas) {
    if (!metasByNode[event.node]) metasByNode[event.node] = new Set();
    event.metas.forEach(m => metasByNode[event.node].add(m));
  }
});

// Build index: meta -> events
const eventsByMeta = {};
EVENTS.forEach((event, idx) => {
  const metas = [];
  if (event.meta) metas.push(event.meta);
  if (event.metas) metas.push(...event.metas);
  if (event.resolvedMetas) metas.push(...event.resolvedMetas);
  if (event.from) metas.push(event.from);
  if (event.to) metas.push(event.to);

  metas.forEach(meta => {
    if (!eventsByMeta[meta]) eventsByMeta[meta] = [];
    eventsByMeta[meta].push(idx);
  });
});

// Build index: constraint -> events
const eventsByConstraint = {};
EVENTS.forEach((event, idx) => {
  if (event.constraintId !== undefined) {
    if (!eventsByConstraint[event.constraintId]) eventsByConstraint[event.constraintId] = [];
    eventsByConstraint[event.constraintId].push(idx);
  }
});

document.querySelectorAll('.node').forEach(node => {
  node.addEventListener('click', function(e) {
    e.stopPropagation();
    if (selectedNode) {
      selectedNode.classList.remove('selected');
    }
    this.classList.add('selected');
    selectedNode = this;
    selectedMeta = null;
    showNodeStory(this);
  });
});

document.addEventListener('click', function() {
  if (selectedNode) {
    selectedNode.classList.remove('selected');
    selectedNode = null;
  }
  storyContent.innerHTML = '<p class="hint">Click on code to see its type inference story</p>';
});

function showNodeStory(node) {
  const nodeId = node.dataset.node;
  const metas = node.dataset.metas;
  const eventIndices = eventsByNode[nodeId] || [];
  const code = node.textContent.substring(0, 50) + (node.textContent.length > 50 ? '...' : '');

  let html = `
    <div class="story-header">
      <h3>Node ${nodeId}</h3>
      <code>${escapeHtml(code)}</code>
      ${metas ? `<div class="metas">Metas: ${metas.split(', ').map(m =>
        `<span class="meta-tag" onclick="showMetaStory('${m}')">${m}</span>`
      ).join('')}</div>` : ''}
    </div>
  `;

  if (eventIndices.length === 0) {
    html += '<p class="hint">No events for this node</p>';
  } else {
    html += '<ul class="event-list">';
    eventIndices.forEach(idx => {
      html += renderEvent(EVENTS[idx], idx);
    });
    html += '</ul>';
  }

  storyContent.innerHTML = html;
}

function showMetaStory(meta) {
  selectedMeta = meta;
  const eventIndices = eventsByMeta[meta] || [];

  let html = `
    <div class="story-header">
      <h3>Meta ${meta}</h3>
      <div class="metas">Journey through type inference</div>
    </div>
  `;

  if (eventIndices.length === 0) {
    html += '<p class="hint">No events for this meta</p>';
  } else {
    html += '<ul class="event-list">';
    eventIndices.forEach(idx => {
      html += renderEvent(EVENTS[idx], idx);
    });
    html += '</ul>';
  }

  storyContent.innerHTML = html;
}

function showConstraintStory(constraintId) {
  const eventIndices = eventsByConstraint[constraintId] || [];

  let html = `
    <div class="story-header">
      <h3>Constraint #${constraintId}</h3>
      <div class="metas">Lifecycle</div>
    </div>
  `;

  if (eventIndices.length === 0) {
    html += '<p class="hint">No events for this constraint</p>';
  } else {
    html += '<ul class="event-list">';
    eventIndices.forEach(idx => {
      html += renderEvent(EVENTS[idx], idx);
    });
    html += '</ul>';
  }

  storyContent.innerHTML = html;
}

function renderEvent(event, idx) {
  const typeClass = event.type.replace(/([A-Z])/g, '-$1').toLowerCase().substring(1);
  let detail = '';

  switch (event.type) {
    case 'MetaCreated':
      detail = `<span class="meta-tag" onclick="showMetaStory('${event.meta}')">${event.meta}</span> at level ${event.level}`;
      break;
    case 'ConstraintCreated':
      detail = `<span onclick="showConstraintStory(${event.constraintId})" style="cursor:pointer">#${event.constraintId}</span> ${event.kind} with metas: ${(event.metas || []).map(m =>
        `<span class="meta-tag" onclick="showMetaStory('${m}')">${m}</span>`
      ).join('')}`;
      break;
    case 'ConstraintDeferred':
      detail = `<span onclick="showConstraintStory(${event.constraintId})" style="cursor:pointer">#${event.constraintId}</span> - ${event.reason}`;
      break;
    case 'ConstraintWoken':
      detail = `<span onclick="showConstraintStory(${event.constraintId})" style="cursor:pointer">#${event.constraintId}</span> woken by ${event.wokenBy}`;
      break;
    case 'ConstraintSolved':
      detail = `<span onclick="showConstraintStory(${event.constraintId})" style="cursor:pointer">#${event.constraintId}</span> resolved: ${(event.resolvedMetas || []).map(m =>
        `<span class="meta-tag" onclick="showMetaStory('${m}')">${m}</span>`
      ).join('')}`;
      break;
    case 'MetaUnified':
      detail = `<span class="meta-tag" onclick="showMetaStory('${event.meta}')">${event.meta}</span> = ${event.unifiedWith}`;
      if (event.viaConstraint) detail += ` via <span onclick="showConstraintStory(${event.viaConstraint})" style="cursor:pointer">#${event.viaConstraint}</span>`;
      break;
    case 'MetaLinked':
      detail = `<span class="meta-tag" onclick="showMetaStory('${event.from}')">${event.from}</span> -> <span class="meta-tag" onclick="showMetaStory('${event.to}')">${event.to}</span>`;
      break;
  }

  return `<li class="event-item ${typeClass}"><span class="event-type">${event.type}</span><span class="event-detail">${detail}</span></li>`;
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// File tabs
document.querySelectorAll('.file-tab').forEach(tab => {
  tab.addEventListener('click', function() {
    const fileIndex = this.dataset.file;
    document.querySelectorAll('.file-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.file-content').forEach(c => c.style.display = 'none');
    this.classList.add('active');
    document.querySelector(`.file-content[data-file="${fileIndex}"]`).style.display = 'block';
  });
});
</script>
</body>
</html>
